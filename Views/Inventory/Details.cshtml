@model InventoryManager.Models.ViewModels.InventoryDetailsViewModel
@using InventoryManager.Models.ViewModels

@{
    ViewData["Title"] = "Inventory Details";
}

@* Inventory header information *@
<h1>@Model.Inventory.Title</h1>
@Html.AntiForgeryToken()

<div>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">Description</dt>
        <dd class="col-sm-10">@Model.Inventory.Description</dd>

        <dt class="col-sm-2">Category</dt>
        <dd class="col-sm-10">@Model.Inventory.Category</dd>

        <dt class="col-sm-2">Created At</dt>
        <dd class="col-sm-10">@Model.Inventory.CreatedAt</dd>
    </dl>
</div>

@* -----------------------------------------------------------------------
   Tabs Navigation
   - Items and Discussion are visible to everyone.
   - Access tab is only shown to the Owner (IsOwner flag from controller).
   WHY HIDE ACCESS TAB FROM NON-OWNERS?
   Only the owner can manage who has access. Showing the tab to granted users
   would be confusing and expose information they don't need.
   ----------------------------------------------------------------------- *@
<ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="items-tab"
                data-bs-toggle="tab" data-bs-target="#items"
                type="button" role="tab" aria-controls="items" aria-selected="true">
            Items
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="discussion-tab"
                data-bs-toggle="tab" data-bs-target="#discussion"
                type="button" role="tab" aria-controls="discussion" aria-selected="false">
            Discussion
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="statistics-tab"
                data-bs-toggle="tab" data-bs-target="#statistics"
                type="button" role="tab" aria-controls="statistics" aria-selected="false">
            Statistics
        </button>
    </li>

    @* Access tab — owner only *@
    @if (Model.IsOwner)
    {
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="access-tab"
                    data-bs-toggle="tab" data-bs-target="#access"
                    type="button" role="tab" aria-controls="access" aria-selected="false">
                Access
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab"
                    data-bs-toggle="tab" data-bs-target="#settings"
                    type="button" role="tab" aria-controls="settings" aria-selected="false">
                Settings
            </button>
        </li>
    }
</ul>

@* Tabs Content *@
<div class="tab-content" id="inventoryTabsContent">

    @* -----------------------------------------------------------------------
       Items Tab
       Add Item button and Delete buttons use CanEdit (not IsOwner).
       WHY CanEdit INSTEAD OF IsOwner?
       Granted users also need to add/delete items. IsOwner would deny them.
       CanEdit is true for both the owner and explicitly granted users.
       ----------------------------------------------------------------------- *@
    <div class="tab-pane fade show active p-3 border border-top-0"
         id="items" role="tabpanel" aria-labelledby="items-tab">

        @if (Model.CanEdit)
        {
            <div class="mb-3">
                <a asp-controller="Item" asp-action="Create"
                   asp-route-inventoryId="@Model.Inventory.Id"
                   class="btn btn-primary">Add Item</a>
            </div>
        }

        @await Html.PartialAsync("_ItemsTab", Model)
    </div>

    @* Statistics Tab *@
    <div class="tab-pane fade p-3 border border-top-0"
         id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
        @await Html.PartialAsync("_StatisticsTab", Model)
    </div>

    @* Discussion Tab — real-time via SignalR, server-rendered posts on initial load *@
    <div class="tab-pane fade p-3 border border-top-0"
         id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
        @{
            var discussionVm = new InventoryManager.Models.ViewModels.DiscussionTabViewModel
            {
                InventoryId = Model.Inventory.Id,
                Posts = Model.DiscussionPosts
            };
        }
        @await Html.PartialAsync("_DiscussionTab", discussionVm)
    </div>

    @* Access Tab and Settings Tab — owner only *@
    @if (Model.IsOwner)
    {
        @* -----------------------------------------------------------------------
           Access Tab
           Renders the _AccessTab partial with an AccessManageVM.
           The partial handles the grant/remove forms.
           ----------------------------------------------------------------------- *@
        <div class="tab-pane fade p-3 border border-top-0"
             id="access" role="tabpanel" aria-labelledby="access-tab">
            @{
                var accessVm = new AccessManageVM
                {
                    InventoryId = Model.Inventory.Id,
                    UsersWithAccess = Model.UsersWithAccess
                };
            }
            @await Html.PartialAsync("_AccessTab", accessVm)
        </div>

        <div class="tab-pane fade p-3 border border-top-0"
             id="settings" role="tabpanel" aria-labelledby="settings-tab">
            <p>Inventory settings (owner only).</p>
        </div>
    }

</div>

<div class="mt-3">
    <a asp-action="Index">Back to List</a>
</div>

@*
    Scripts section — only loaded on this page.
    WHY LOAD SIGNALR HERE AND NOT IN _Layout?
    SignalR is only needed on the Inventory Details page.
    Loading it globally would waste bandwidth on every other page.
    The layout's @await RenderSectionAsync("Scripts", required: false) renders this block.
*@
@section Scripts {
    @* SignalR JavaScript client — loaded from CDN, no local copy required *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"
            integrity="sha512-O9LCEFBnkSBqhqBWHBBCkSzFBGDEFMYfXQHBFRaOhvSFQjFMHpFKBrSdVlMUBssHSGMBMBbJFLFpBDXFMqbQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    @* Discussion real-time logic *@
    <script src="~/js/discussion-signalr.js" asp-append-version="true"></script>
}
